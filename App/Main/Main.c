/*********************************************************************************************************
* 模块名称：Main.c
* 文件说明：系统主入口文件
*           负责系统软硬件初始化，以及周期性任务调度
* 版本信息：V1.0.0
* 作    者：Chill
* 完成日期：2026-02-06
* 注意事项：需在 Keil 中勾选 Use MicroLIB，否则 printf 无法正常输出
*********************************************************************************************************/

/*********************************************************************************************************
*                                           头文件包含
*********************************************************************************************************/
#include "Main.h"
#include "stm32f10x_conf.h"
#include "DataType.h"
#include "NVIC.h"
#include "SysTick.h"
#include "RCC.h"
#include "Timer.h"
#include "UART1.h"
#include "LED.h"
#include "DAC.h"
#include "ADC.h"
#include "OLED.h"
#include "ECG.h"
#include "RESP.h"
#include "SPO2.h"

/*********************************************************************************************************
*                                           全局变量
*********************************************************************************************************/
/* 当前OLED显示的波形模式（心电 / 呼吸 / 血氧） */
WaveMode_t g_displayMode = WAVE_ECG;

/*********************************************************************************************************
*                                       内部函数声明
*********************************************************************************************************/
static void InitSoftware(void);   // 软件模块初始化
static void InitHardware(void);   // 硬件外设初始化
static void Proc2msTask(void);    // 2ms 周期任务
static void Proc1SecTask(void);   // 1s 周期任务

/*********************************************************************************************************
* 函数名称：InitSoftware
* 功    能：初始化所有纯软件逻辑相关模块
*********************************************************************************************************/
static void InitSoftware(void)
{

}

/*********************************************************************************************************
* 函数名称：InitHardware
* 功    能：初始化所有硬件外设
*********************************************************************************************************/
static void InitHardware(void)
{
	SystemInit();           // STM32 系统时钟初始化
	InitRCC();              // RCC 时钟配置
	InitNVIC();             // 中断优先级配置
	InitUART1(115200);      // 串口1初始化，用于调试和指令接收
	InitTimer();            // 定时器初始化
	InitLED();              // LED 指示灯初始化
	InitSysTick();          // SysTick 定时器（2ms / 1s 任务基准）
	InitDAC();              // DAC 初始化
	InitADC();              // ADC 初始化
	InitOLED();             // OLED 显示初始化
	InitECG();              // ECG 采集模块初始化
	InitRESP();             // 呼吸信号采集初始化
	InitSPO2();             // 血氧模块初始化
}

/*********************************************************************************************************
* 函数名称：Proc2msTask
* 功    能：2ms 周期执行的实时任务
* 说    明：主要用于数据采样、协议处理等实时性较高的任务
*********************************************************************************************************/
static void Proc2msTask(void)
{
    u8  uart1RecData;       // 串口接收到的数据
    u16 ecg_adcData;        // 心电 ADC 数据
    u16 resp_adcData;       // 呼吸 ADC 数据

    static u8 s_iCnt4 = 0;  // 2ms 计数器，用于构造 8ms 周期

    if (Get2msFlag())
    {
			/* 接收串口指令，用于切换显示波形 */
			if (ReadUART1(&uart1RecData, 1))
			{
				printf("receive %d\r\n", uart1RecData);

				switch (uart1RecData)
				{
					case WAVE_ECG:
					case WAVE_RESP:
					case WAVE_SPO2:
						g_displayMode = (WaveMode_t)uart1RecData;  // 更新显示模式
						break;

					default:
						/* 非法指令，忽略 */
						break;
				}
			}

			/* 每 8ms 执行一次信号处理任务 */
			if (s_iCnt4 >= 3)
			{
				ecg_adcData  = ReadECGADC();
				ECGTask(ecg_adcData);

				resp_adcData = ReadRESPADC();
				RESPTask(resp_adcData);

				SPO2Task();

				s_iCnt4 = 0;
			}
			else
			{
				s_iCnt4++;
			}

			LEDFlicker(250);    // LED 心跳指示
			Clr2msFlag();       // 清除 2ms 标志
    }
}

/*********************************************************************************************************
* 函数名称：Proc1SecTask
* 功    能：1s 周期执行的低频任务
* 说    明：主要用于 OLED 显示刷新
*********************************************************************************************************/
static void Proc1SecTask(void)
{
    if (Get1SecFlag())
    {
			OLEDClear();        // 清屏
			OLED_ECG();         // 显示 ECG 信息
			OLED_RESP();        // 显示 RESP 信息
			OLED_SPO2();        // 显示 SPO2 信息
			OLEDRefreshGRAM();	// 刷新 OLED 显存

			Clr1SecFlag();
    }
}

/*********************************************************************************************************
* 函数名称：main
* 功    能：程序入口
*********************************************************************************************************/
int main(void)
{
	InitSoftware();         // 软件初始化
	InitHardware();         // 硬件初始化

	DelayNms(300);          // 等待系统稳定
	printf("Init System has been finished.\r\n");

	while (1)
	{
		Proc2msTask();      // 实时任务
		Proc1SecTask();     // 显示任务
	}
}
